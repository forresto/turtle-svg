<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>LASER TURTLE -- Turtle Graphics to SVG</title>
  <style type="text/css" media="screen">
    #editor { 
      position: absolute;
      top: 0;
      left: 0;
      bottom: 40px;
      width: 400px;
    }

    #commands {
      position: absolute;
      left: 0;
      bottom: 0;
      width: 380px;
      height: 40px;

      text-align: right;
      font-size: 20px;
    }
      button {
        font-size: 15px;
      }

    #right-column {
      position: absolute;
      top: 0;
      left: 400px;
      bottom: 0;
      right: 0;
      overflow: auto; 
    }

    #export {
      position: fixed;
      top: 0;
      right: 0;
    }

    #help {
      display: none;

      background-color: rgba(238, 246, 108, 0.95);
      border-radius: 10px;
      margin: 10px;
      padding: 10px;
      z-index: 99;
    }

    /* ACE highlight fix */
    .ace-monokai .ace_marker-layer .ace_selection {
      background: #060 !important;
    }

  </style>

  <script src="js/rawinflate.js"></script>
  <script src="js/rawdeflate.js"></script>

</head>
<body>

<div id="editor">// Press [?] for help

moveForward(100);
turnLeft(1/4);
moveForward(100);
turnLeft(1/4);
moveForward(100);
</div>

<div id="commands">
  <button id="link">Save code to URL</button>
  <button id="apply" disabled="disabled">Apply</button>
  <input id="auto" type="checkbox" checked="checked" /><label for="auto">auto</label>
  <button id="show-help">?</button>
</div>

<div id="right-column">

  <div id="svgContainer"><svg id="svgOutput" xmlns="http://www.w3.org/2000/svg" version="1.1" width="500" height="500">
  <path id="turtle" d="M 0 0 " stroke="black" fill="none" vector-effect="non-scaling-stroke" />
</svg></div>

  <div id="help">
<pre>Source: <a href="https://github.com/forresto/turtle-svg">https://github.com/forresto/turtle-svg</a>
   __   ___   ___________    ________  _____  ________   ____
  / /  / _ | / __/ __/ _ \  /_  __/ / / / _ \/_  __/ /  / __/
 / /__/ __ |_\ \/ _// , _/   / / / /_/ / , _/ / / / /__/ _/  
/____/_/ |_/___/___/_/|_|   /_/  \____/_/|_| /_/ /____/___/  

Welcome to the JS turtle graphics -> SVG generator. 
This will generate an SVG file with one &lt;path&gt; element.
The turtle starts in the middle facing down.
Angles: 0 is down, 1/4 is right, 1/2 is up, 3/4 is left

// Pen (laser, blade) commands
penUp();               // Shortcut u()
penDown();             // d()

// Relative move
moveForward(distance); // f()

// Relative turns
turnRight(angle);      // r()
turnLeft(angle);       // l()

// Absolute turns
turnTo(angle);         // t()

// Angles for turn commands are 0.0 to 1.0
turnRight(1/4);        // Turn right 90ยบ
turnLeft(1/360);       // Turn left 1ยบ

// SVG move (pen not drawing) and line (drawing)
// Relative
moveBy(x, y); 
lineBy(x, y);
// Absolute
moveTo(x, y); 
lineTo(x, y);

// Functions and commands are JS:
var drawRegular = function(sideCount, sideLength) {
  for (var i=0; i&lt;sideCount; i++){
    moveForward(sideLength);
    turnRight(1/sideCount);
  }
};
drawRegular(5, 20);

// Draw a square:
moveForward(100);
turnLeft(1/4);
moveForward(100);
turnLeft(1/4);
moveForward(100);
turnLeft(1/4);
moveForward(100);

// Draw a recursive space-filling curve:
var segmentLength = 15;
function unit(iteration) {
  if (iteration > 0) {
    unit(iteration - 1);
    r(0.25);
    unit(iteration - 1);
    f(segmentLength);
    unit(iteration - 1);
    r(0.25);
    unit(iteration - 1);
  }
}
moveTo(30, 20);
turnTo(3/8);
unit(6);
f(segmentLength);
unit(6);

// Draw golden ratio squares with Phi
var PHI = (1 + Math.sqrt(5)) / 2;
var scale = 300;
var i = 0;
moveTo(20, 20);
while( scale &gt;= 1 ){
  f(scale);
  l(1/4);
  f(scale);
  l(1/4);
  f(scale);
  l(1/4);
  f(scale);
  l(1/4);
  f(scale);
  scale = scale/PHI;
  f(scale);
  l(1/4);
}

// Draw golden ratio squares with Fibonacci
var side = 3;
var lastSide = 0;
var nextSide;
moveTo(550, 350);
while( side &lt; 1200 ){
  // Draw square
  f(side);
  l(1/4);
  f(side);
  l(1/4);
  f(side);
  l(1/4);
  f(side);
  l(1/4);
  f(side);
  l(1/4);
  f(side);
  // Advance fib
  nextSide = side + lastSide;
  lastSide = side;
  side = nextSide;
}


</pre>
  </div>

  <button id="export">Export</button>

</div>


<script src="http://d1n0x3qji82z53.cloudfront.net/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script>
window.onload = function(){

  ace.config.set("workerPath", ".");
  var editor = ace.edit("editor");
  editor.setTheme("ace/theme/monokai");
  var session = editor.getSession();
  session.setMode("ace/mode/javascript");
  session.setTabSize(2);

  var applyButton = document.getElementById("apply");
  var autoCheck = document.getElementById("auto");
  var helpButton = document.getElementById("show-help");
  var exportButton = document.getElementById("export");
  var rightColumn = document.getElementById("right-column");
  var link = document.getElementById("link");
  var help = document.getElementById("help");
  var svg = document.getElementById("svgOutput");
  var path = svg.getElementById("turtle");

  var changeTimeout;
  var testCodeStart;
  var testCodeWorking = true;
  var testingCode;

  var autoEval = true;

  var worker;
  var workerBusy = false;
  var workerError = false;

  var setupWorker = function(){
    worker = new Worker('turtle-svg-worker.js');
    worker.onmessage = function(e) {
      if (e.data === ""){
        workerError = true;
        applyButton.innerHTML = "JS error... restart?";
        applyButton.disabled = false;
      } else {
        workerError = false;
        applyButton.innerHTML = "Apply";
        applyButton.disabled = autoEval;
        setPath(e.data);
      }
      workerBusy = false;
    };
    worker.onerror = function(e) {
      console.log("worker error", e);
    };
    workerError = false;
    workerBusy = false;
  }
  setupWorker();

  var testCode = function(){
    if (worker && !workerBusy) {
      workerBusy = true;
      applyButton.innerHTML = "Working... cancel?";
      applyButton.disabled = false;
      testCodeStart = Date.now();
      testingCode = editor.getValue();
      worker.postMessage(testingCode);      
    } else {
      // ?
    }
  };

  autoCheck.onchange = function(e){
    autoEval = autoCheck.checked;
    applyButton.disabled = autoEval;
    if (autoEval) {
      testCode();
    }
  };

  applyButton.onclick = function(){
    // Restart
    if (worker && (workerBusy || workerError)) {
      worker.terminate();
      setupWorker();
      applyButton.innerHTML = "Apply";

      autoCheck.checked = false;
      autoCheck.onchange();
    } else {
      testCode();
    }
  };

  session.on("change", function (e) {
    if (!autoEval){
      return;
    }
    if(changeTimeout) {
      clearTimeout(changeTimeout);
    }
    changeTimeout = setTimeout(testCode, 500);
  });

  var setPath = function(d){
    path.setAttributeNS(null, "d", d);

    var bBox = path.getBBox();
    var w = Math.max(500, Math.ceil(bBox.x+bBox.width+20));
    var h = Math.max(500, Math.ceil(bBox.y+bBox.height+20));
    svg.setAttribute("width", w);
    svg.setAttribute("height", h);
  };


  var helpShown = false;
  helpButton.onclick = function(){
    helpShown = !helpShown;
    help.style.display = helpShown ? "block" : "none";
    rightColumn.scrollTop = helpShown ? help.offsetTop : 0;
  };

  window.URL = window.URL || window.webkitURL || window.mozURL || window.msURL || null;
  exportButton.onclick = function(){
    var packed = encode( editor.getValue() );
    var perma = 'http://forresto.github.com/turtle-svg/#code/' + packed;
    var comment = "<!-- \n\nMade with LASER TURTLE; here is editor and source: \n" + perma + "\n\n-->\n";
    var svgString = document.getElementById("svgContainer").innerHTML;
    var svgBlob = new Blob([comment,svgString], { "type" : "image/svg+xml" });
    var svgBlobURL = URL.createObjectURL(svgBlob);
    if (svgBlobURL) {
      window.open(svgBlobURL);
      // window.URL.revokeObjectURL(svgBlobURL); 
    } else {
      window.open("data:image/svg+xml,"+svgString);
    }
  }

  // Compress code for sharing
  link.onclick = function(){
    // With help from https://github.com/mrdoob/htmleditor
    var packed = encode( editor.getValue() );
    var perma = 'http://forresto.github.com/turtle-svg/#code/' + packed;
    // window.location.replace("#code/"+packed); 
    window.location.href = "#code/"+packed;
  }
  var decode = function ( string ) {
    return RawDeflate.inflate( window.atob( string ) );
  };
  var encode = function ( string ) {
    return window.btoa( RawDeflate.deflate( string ) );
  };

  var loadCodeFromHash = function(e){
    if (window.location.hash.substr(0,5) === "#code") {
      try {
        var code = decode( window.location.hash.substr(6) );
        editor.setValue(code, 1);
        testCode();
      } catch (e) {}
    }
  }
  window.onhashchange = loadCodeFromHash;

  // See if code is set on load
  if ( window.location.hash ) {
    loadCodeFromHash();
  } else {
    // Default code
    testCode();
  }




}
</script>
</body>
</html>